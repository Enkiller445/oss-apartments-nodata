<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°—Ç–∞—Ç—É—Å –∫–≤–∞—Ä—Ç–∏—Ä –ø–æ –û–°–°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #d1eaf5;
      color: #2d2d2d;
      padding: 20px;
    }

    header h1 {
      font-size: 22px;
      margin-bottom: 10px;
      text-align: center;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .info-panel {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .status-column, .analytics-column {
      font-size: 14px;
      line-height: 1.6;
      text-align: left;
      min-width: 240px;
    }

    .status-column label {
      display: block;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .status-column input {
      margin-right: 6px;
    }

    .green { color: #00c853; }
    .blue { color: #6fa8dc; }
    .yellow { color: #fbc02d; }
    .red { color: #e53935; }
    .gray { color: #666; }

    .filters {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  text-align: center;
}

.filters label {
  font-size: 14px;
}

@media (max-width: 480px) {
  .filters {
    flex-direction: column;
    align-items: stretch;
  }

  .filters label {
    width: 100%;
  }

  .filters input,
  .filters select {
    width: 100%;
    max-width: 300px;
  }
}


    .building {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
    }

    .entrance-block {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .entrance-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .entrance {
      display: flex;
    }

    .floor-labels {
      display: flex;
      flex-direction: column;
      margin-right: 5px;
    }

    .floor-labels div {
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      font-size: 11px;
      color: #555;
      width: 22px;
      font-weight: bold;
    }

    .columns {
      display: flex;
      flex-direction: column;
    }

    .row {
      display: flex;
      gap: 2px;
    }

    .cell {
      width: 28px;
      height: 28px;
      background-color: transparent;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
    }

    .cell.green { background-color: #00c853; color: #fff; font-weight: bold; }
    .cell.blue  { background-color: #6fa8dc; color: #fff; font-weight: bold; }
    .cell.yellow { background-color: #fbc02d; color: #000; font-weight: bold; }
    .cell.red { background-color: #e53935; color: #fff; font-weight: bold; }
    .cell.nodata { background-color: #fffdf5; border: 1px solid #ccc; }
    .cell.highlight { outline: 2px solid #ffeb3b !important; background-color: #fff59d !important; font-weight: bold; z-index: 10; }

    #apt-info {
  background: #ffffffaa;
  padding: 12px 16px;
  margin: 10px 0 20px;
  border-radius: 10px;
  font-size: 15px;
  font-weight: normal;
  color: #333;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  text-align: center;
  line-height: 1.5;
  max-width: 95vw;
}


    #loading {
      font-weight: bold;
      margin: 20px;
      font-size: 16px;
      color: #444;
    }

    .spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .info-panel {
        flex-direction: column;
        align-items: center;
      }
      .cell {
        width: 24px;
        height: 24px;
        font-size: 9px;
      }
      .floor-labels div {
        height: 24px;
        font-size: 9px;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>–°—Ç–∞—Ç—É—Å –∫–≤–∞—Ä—Ç–∏—Ä –ø–æ —É—á–∞—Å—Ç–∏—é –≤ –û–°–°</h1>
  </header>

  <main>
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... <span class="spinner">‚è≥</span></div>

    <div class="info-panel">
      <div class="status-column">
        <label><input type="checkbox" id="show-green" checked onchange="render()"> <span class="green">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏:</span> <span id="count-green"><span class="spinner">‚è≥</span></span> (<span id="percent-green"><span class="spinner">‚è≥</span></span>%)</label>
        <label><input type="checkbox" id="show-blue" checked onchange="render()"> <span class="blue">–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –±—é–ª–ª–µ—Ç–µ–Ω—å:</span> <span id="count-blue"><span class="spinner">‚è≥</span></span> (<span id="percent-blue"><span class="spinner">‚è≥</span></span>%)</label>
        <label><input type="checkbox" id="show-yellow" checked onchange="render()"> <span class="yellow">–û–∂–∏–¥–∞–µ—Ç—Å—è –≤–æ–∑–≤—Ä–∞—Ç:</span> <span id="count-yellow"><span class="spinner">‚è≥</span></span> (<span id="percent-yellow"><span class="spinner">‚è≥</span></span>%)</label>
        <label><input type="checkbox" id="show-red" checked onchange="render()"> <span class="red">–û—Ç–∫–∞–∑–∞–ª–∏—Å—å:</span> <span id="count-red"><span class="spinner">‚è≥</span></span> (<span id="percent-red"><span class="spinner">‚è≥</span></span>%)</label>
        <label><input type="checkbox" id="show-nodata" checked onchange="render()"> <span class="gray">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö:</span> <span id="count-nodata"><span class="spinner">‚è≥</span></span> (<span id="percent-nodata"><span class="spinner">‚è≥</span></span>%)</label>
      </div>

      <div class="analytics-column">
        <div><strong>–í–æ–∑–º–æ–∂–Ω—ã–π –∫–≤–æ—Ä—É–º –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:</strong> <span id="kvorum-today"><span class="spinner">‚è≥</span></span>%</div>
        <div><strong>–û–°–° –∏–¥—ë—Ç –¥–Ω–µ–π:</strong> <span id="oss-days"><span class="spinner">‚è≥</span></span></div>
        <div><strong>–°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø:</strong> <span id="avg-speed"><span class="spinner">‚è≥</span></span>% –≤ –¥–µ–Ω—å</div>
        <div><strong>–û–°–° –æ—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:</strong> <span id="oss-left"><span class="spinner">‚è≥</span></span></div>
        <div><strong>–ü—Ä–æ–≥–Ω–æ–∑ –∫–≤–æ—Ä—É–º–∞:</strong> <span id="kvorum-final"><span class="spinner">‚è≥</span></span>%</div>
      </div>
    </div>

    <div class="filters">
      <label for="entranceFilter">–ü–æ–¥—ä–µ–∑–¥:
        <select id="entranceFilter" onchange="render()">
          <option value="all">–í—Å–µ</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </label>
      &nbsp;&nbsp;
      <label for="aptSearch">–ö–≤–∞—Ä—Ç–∏—Ä–∞:
        <input type="search" id="aptSearch" placeholder="–ù–æ–º–µ—Ä" oninput="render()" />
      </label>
    </div>

    <div id="apt-info"></div>
    <div class="building" id="building"></div>
  </main>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRRbhD4HVJzaB0vZwakUhpv0rHu3LvS0Gxq3zl4Qo9dANsvW8LosfiylBqljl2dVV1vmMNpOpP0516/pub?gid=63142697&single=true&output=csv';
    const startDate = new Date('2025-04-10');
    const endDate = new Date('2025-08-10');
    const correctionFactor = 0.8;
    const entrances = [
      { count: 5, start: 1 },
      { count: 5, start: 106 },
      { count: 6, start: 211 },
      { count: 10, start: 337 },
      { count: 9, start: 547 }
    ];
    const floors = 21;
    const floorNumbers = Array.from({ length: floors }, (_, i) => i + 2);
    let statusMap = {};
    const statusLabel = {
      green: "–ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏",
      blue: "–ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –±—é–ª–ª–µ—Ç–µ–Ω—å",
      yellow: "–æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–æ–∑–≤—Ä–∞—Ç",
      red: "–æ—Ç–∫–∞–∑–∞–ª–∏—Å—å",
      nodata: "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    };

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        document.getElementById("loading").style.display = "none";
        results.data.forEach(row => {
          const apt = parseInt(row["–ö–≤–∞—Ä—Ç–∏—Ä–∞"]);
          const color = row["–¶–≤–µ—Ç"]?.trim().toLowerCase();
          if (!apt) return;
          if (color === "#00ff00") statusMap[apt] = "green";
          else if (color === "#6fa8dc" || color === "#6d9eeb") statusMap[apt] = "blue";
          else if (color === "#ffff00") statusMap[apt] = "yellow";
          else if (color === "#ff0000") statusMap[apt] = "red";
          else statusMap[apt] = "nodata";
        });
        render();
      }
    });

    function updateStatistics() {
      const selectedEntrance = document.getElementById("entranceFilter").value;
      let counts = { green: 0, blue: 0, yellow: 0, red: 0, nodata: 0 };
      let total = 0;

      entrances.forEach((entrance, index) => {
        const entranceNumber = index + 1;
        if (selectedEntrance !== 'all' && parseInt(selectedEntrance) !== entranceNumber) return;

        for (let floor = 0; floor < floors; floor++) {
          for (let apt = 0; apt < entrance.count; apt++) {
            const aptNumber = entrance.start + floor * entrance.count + apt;
            const status = statusMap[aptNumber] || "nodata";
            counts[status]++;
            total++;
          }
        }
      });

      ["green", "blue", "yellow", "red", "nodata"].forEach(type => {
        document.getElementById(`count-${type}`).textContent = counts[type];
        document.getElementById(`percent-${type}`).textContent = total > 0 ? ((counts[type] / total) * 100).toFixed(1) : "0";
      });

      const now = new Date();
      const daysPassed = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
      const daysLeft = Math.max(0, Math.floor((endDate - now) / (1000 * 60 * 60 * 24)));

      const percentGreen = (counts.green / total) * 100;
      const percentBlue = (counts.blue / total) * 100;
      const percentYellow = (counts.yellow / total) * 100;

      const kvorumToday = (percentGreen + percentBlue + percentYellow).toFixed(1);
      const avgSpeed = daysPassed > 0 ? (percentGreen / daysPassed).toFixed(2) : "0";
      let forecast = (parseFloat(avgSpeed) * daysLeft * correctionFactor + percentGreen).toFixed(1);

      if (forecast > 100) forecast = 100;

      document.getElementById("kvorum-today").textContent = kvorumToday;
      document.getElementById("oss-days").textContent = daysPassed;
      document.getElementById("avg-speed").textContent = avgSpeed;
      document.getElementById("oss-left").textContent = daysLeft;
      document.getElementById("kvorum-final").textContent = forecast;
    }

    function render() {
      updateStatistics();
      const buildingDiv = document.getElementById("building");
      buildingDiv.innerHTML = '';

      const show = {
        green: document.getElementById("show-green").checked,
        blue: document.getElementById("show-blue").checked,
        yellow: document.getElementById("show-yellow").checked,
        red: document.getElementById("show-red").checked,
        nodata: document.getElementById("show-nodata").checked
      };

      const selectedEntrance = document.getElementById("entranceFilter").value;
      const searchApt = parseInt(document.getElementById("aptSearch").value);

      entrances.forEach((entrance, index) => {
        const entranceNumber = index + 1;
        if (selectedEntrance !== 'all' && parseInt(selectedEntrance) !== entranceNumber) return;

        const wrapper = document.createElement("div");
        wrapper.className = "entrance-block";

        const title = document.createElement("div");
        title.className = "entrance-title";
        title.textContent = `–ü–æ–¥—ä–µ–∑–¥ ${entranceNumber}`;

        const floorGroup = document.createElement("div");
        floorGroup.className = "entrance";

        const floorLabels = document.createElement("div");
        floorLabels.className = "floor-labels";

        const grid = document.createElement("div");
        grid.className = "columns";

        for (let i = 0; i < floors; i++) {
          const floor = floors - 1 - i;
          const row = document.createElement("div");
          row.className = "row";

          for (let apt = 0; apt < entrance.count; apt++) {
            const aptNumber = entrance.start + floor * entrance.count + apt;
            const cell = document.createElement("div");
            cell.className = "cell";

            const status = statusMap[aptNumber] || "nodata";
            if (show[status]) cell.classList.add(status);
            if (aptNumber === searchApt) cell.classList.add("highlight");

            cell.textContent = aptNumber;
            row.appendChild(cell);
          }

          const label = document.createElement("div");
          label.textContent = floorNumbers[floor];
          floorLabels.appendChild(label);
          grid.appendChild(row);
        }

        floorGroup.appendChild(floorLabels);
        floorGroup.appendChild(grid);
        wrapper.appendChild(title);
        wrapper.appendChild(floorGroup);
        buildingDiv.appendChild(wrapper);
      });

      const aptInfo = document.getElementById("apt-info");
      if (!isNaN(searchApt)) {
        let found = false;
        for (let e = 0; e < entrances.length; e++) {
          const entrance = entrances[e];
          const start = entrance.start;
          const end = entrance.start + entrance.count * floors;
          if (searchApt >= start && searchApt < end) {
            const localIndex = searchApt - start;
            const floor = Math.floor(localIndex / entrance.count) + 2;
            const status = statusMap[searchApt] || "nodata";
            aptInfo.innerHTML = `
  üè† <strong>–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${searchApt}</strong><br>
  üö™ –ü–æ–¥—ä–µ–∑–¥ <strong>${e + 1}</strong><br>
  ‚¨Ü –≠—Ç–∞–∂ <strong>${floor}</strong><br>
  ${status === "green" ? "üü¢" :
    status === "blue" ? "üîµ" :
    status === "yellow" ? "üü°" :
    status === "red" ? "üî¥" : "‚ö™"} ${statusLabel[status]}
`;

            found = true;
            break;
          }
        }
        if (!found) {
          aptInfo.textContent = `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${searchApt} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–æ–¥—ä–µ–∑–¥–æ–≤`;
        }
      } else {
        aptInfo.textContent = '';
      }
    }
  </script>

</body>
</html>
